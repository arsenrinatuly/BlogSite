{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <!-- –°–æ–æ–±—â–µ–Ω–∏—è Django -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:"info" }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="col-lg-8">
      <!-- –ü–æ—Å—Ç -->
      <div class="card mb-4 shadow-sm">
        {% if post.image %}
          <img src="{{ post.image.url }}" class="card-img-top" alt="Post image">
        {% endif %}
        <div class="card-body">
          <h1 class="card-title h3">{{ post.title }}</h1>
          <div class="d-flex align-items-center mb-3">
            <div class="me-3">
              {% if post.author.profile.avatar %}
                <img src="{{ post.author.profile.avatar.url }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;" alt="avatar">
              {% else %}
                <div class="rounded-circle bg-secondary text-white d-inline-flex justify-content-center align-items-center" style="width:48px;height:48px;">
                  {{ post.author.username|slice:":1"|upper }}
                </div>
              {% endif %}
            </div>
            <div>
              <div><strong>{{ post.author.get_full_name|default:post.author.username }}</strong></div>
              <small class="text-muted">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ {{ post.created_at|date:"d M Y H:i" }}</small>
            </div>
          </div>

          <p class="card-text">{{ post.content|linebreaks }}</p>

          <!-- –õ–∞–π–∫–∏ -->
          <div class="d-flex align-items-center justify-content-between mt-4">
            <div>
              <span id="like-count" class="fw-bold">{{ post.total_likes }}</span>
              <small class="text-muted">–ª–∞–π–∫–æ–≤</small>
            </div>

            {% if user.is_authenticated %}
              <button id="like-btn" type="button" class="btn {% if liked %}btn-danger{% else %}btn-outline-danger{% endif %}">
                {% if liked %}üíî –£–±—Ä–∞—Ç—å –ª–∞–π–∫{% else %}‚ù§Ô∏è –õ–∞–π–∫{% endif %}
              </button>
            {% else %}
              <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ª–∞–π–∫–∞—Ç—å</a>
            {% endif %}
          </div>

          <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–º -->
          {% if user == post.author %}
            <div class="mt-3">
              <a href="{% url 'post_update' post.pk %}" class="btn btn-sm btn-outline-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
              <a href="{% url 'post_delete' post.pk %}" class="btn btn-sm btn-outline-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.count }})</h5>

          <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
          <div class="mb-3">
            {% for comment in comments %}
              <div class="border rounded p-2 mb-2">
                <b>{{ comment.author.username }}</b>
                <small class="text-muted">{{ comment.created_at|date:"d M Y H:i" }}</small>
                <p class="mb-0">{{ comment.content|linebreaks }}</p>
              </div>
            {% empty %}
              <p class="text-muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
            {% endfor %}
          </div>

          <!-- –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
          {% if user.is_authenticated %}
            <form method="post" class="mb-3">
              {% csrf_token %}
              <div class="mb-3">
                {{ form.content }}
                <script>
                  document.addEventListener("DOMContentLoaded", function () {
                    var ta = document.querySelector("#id_content");
                    if (ta) {
                      ta.classList.add("form-control");
                      ta.setAttribute("rows", 3);
                      ta.setAttribute("placeholder", "–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...");
                    }
                  });
                </script>
              </div>
              <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>
          {% else %}
            <p><a href="{% url 'login' %}?next={{ request.path }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
          {% endif %}
        </div>
      </div>
    </div>


    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">–û–± –∞–≤—Ç–æ—Ä–µ</h6>
          <div class="d-flex align-items-center">
            {% if post.author.profile.avatar %}
              <img src="{{ post.author.profile.avatar.url }}" class="rounded-circle me-3" style="width:64px;height:64px;object-fit:cover;" alt="avatar">
            {% else %}
              <div class="rounded-circle bg-secondary text-white d-inline-flex justify-content-center align-items-center me-3" style="width:64px;height:64px;">
                {{ post.author.username|slice:":1"|upper }}
              </div>
            {% endif %}
            <div>
              <strong>{{ post.author.get_full_name|default:post.author.username }}</strong>
              <div class="small text-muted">{{ post.author.profile.bio|default:"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" }}</div>
            </div>
          </div>
        </div>
      </div>

<div class="card">
  <div class="card-body">
    <h6 class="card-subtitle mb-2 text-muted">–î—Ä—É–≥–∏–µ –ø–æ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∞</h6>
    <ul class="list-unstyled mb-0">
      {% for p in other_posts %}
        <li><a href="{% url 'post_detail' p.pk %}">{{ p.title|truncatechars:50 }}</a></li>
      {% empty %}
        <li class="text-muted">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ—Å—Ç–æ–≤</li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener("DOMContentLoaded", function() {
  const btn = document.getElementById("like-btn");
  if (btn) {
    btn.addEventListener("click", function() {
      fetch("{% url 'toggle_like' post.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Accept": "application/json"
        }
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("like-count").textContent = data.total_likes;
        btn.textContent = data.liked ? "üíî –£–±—Ä–∞—Ç—å –ª–∞–π–∫" : "‚ù§Ô∏è –õ–∞–π–∫";
        btn.className = data.liked ? "btn btn-danger" : "btn btn-outline-danger";
      });
    });
  }
});
</script>
{% endblock %}
